<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task Update</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Test Aggiornamento Task</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Task con Collaboratore (Monitoraggio)</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testTaskMonitoraggio()">
                            Test Task Monitoraggio
                        </button>
                        <div id="resultMonitoraggio" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Task senza Collaboratore (Campo)</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testTaskCampo()">
                            Test Task Campo
                        </button>
                        <div id="resultCampo" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Spese Comprese/Non Comprese</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-warning" onclick="testSpese()">
                            Test Spese
                        </button>
                        <div id="resultSpese" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function testTaskMonitoraggio() {
            try {
                const formData = {
                    Task: "Test Task Monitoraggio Aggiornato",
                    Desc_Task: "Test per task di monitoraggio con collaboratore",
                    ID_COMMESSA: "COM00001", // Assumi che esista
                    ID_COLLABORATORE: "COL00001", // Solo per monitoraggio
                    Tipo: "Monitoraggio",
                    Stato_Task: "In corso",
                    Data_Apertura_Task: "2025-01-01",
                    gg_previste: 10,
                    Valore_gg: 300,
                    Spese_Comprese: "No",
                    Valore_Spese_std: 100
                };
                
                showLoading('resultMonitoraggio', 'Testando task monitoraggio...');
                
                const response = await fetch('API/index.php?resource=task&action=update&id=TAS00001', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                showResult('resultMonitoraggio', result, 'Task Monitoraggio');
                
            } catch (error) {
                showError('resultMonitoraggio', error.message);
            }
        }
        
        async function testTaskCampo() {
            try {
                const formData = {
                    Task: "Test Task Campo Aggiornato",
                    Desc_Task: "Test per task di campo senza collaboratore",
                    ID_COMMESSA: "COM00001",
                    ID_COLLABORATORE: null, // Null per task non di monitoraggio
                    Tipo: "Campo",
                    Stato_Task: "In corso",
                    Data_Apertura_Task: "2025-01-01",
                    gg_previste: 5,
                    Valore_gg: 250,
                    Spese_Comprese: "Si",
                    Valore_Spese_std: null // Null quando spese comprese
                };
                
                showLoading('resultCampo', 'Testando task campo...');
                
                const response = await fetch('API/index.php?resource=task&action=update&id=TAS00002', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                showResult('resultCampo', result, 'Task Campo');
                
            } catch (error) {
                showError('resultCampo', error.message);
            }
        }
        
        async function testSpese() {
            try {
                // Test 1: Spese comprese (Valore_Spese_std = null)
                const formDataSpeseComprese = {
                    Task: "Test Spese Comprese",
                    ID_COMMESSA: "COM00001",
                    Tipo: "Campo",
                    Stato_Task: "In corso",
                    Spese_Comprese: "Si",
                    Valore_Spese_std: null
                };
                
                // Test 2: Spese non comprese (Valore_Spese_std con valore)
                const formDataSpeseNonComprese = {
                    Task: "Test Spese Non Comprese",
                    ID_COMMESSA: "COM00001",
                    Tipo: "Campo",
                    Stato_Task: "In corso",
                    Spese_Comprese: "No",
                    Valore_Spese_std: 150
                };
                
                showLoading('resultSpese', 'Testando gestione spese...');
                
                // Test entrambi i casi
                const response1 = await fetch('API/index.php?resource=task&action=update&id=TAS00003', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formDataSpeseComprese)
                });
                
                const result1 = await response1.json();
                
                const response2 = await fetch('API/index.php?resource=task&action=update&id=TAS00004', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formDataSpeseNonComprese)
                });
                
                const result2 = await response2.json();
                
                showDoubleResult('resultSpese', result1, result2, 'Spese Comprese', 'Spese Non Comprese');
                
            } catch (error) {
                showError('resultSpese', error.message);
            }
        }
        
        function showLoading(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="text-primary">
                    <i class="spinner-border spinner-border-sm me-2"></i>
                    ${message}
                </div>
            `;
        }
        
        function showResult(elementId, result, testName) {
            const isSuccess = result.success;
            const badgeClass = isSuccess ? 'bg-success' : 'bg-danger';
            const icon = isSuccess ? 'check-circle' : 'exclamation-triangle';
            
            document.getElementById(elementId).innerHTML = `
                <div class="alert alert-${isSuccess ? 'success' : 'danger'}">
                    <h6><span class="badge ${badgeClass}">
                        <i class="fas fa-${icon} me-1"></i>
                        ${testName}
                    </span></h6>
                    <p><strong>Status:</strong> ${isSuccess ? 'SUCCESS' : 'ERROR'}</p>
                    ${result.message ? `<p><strong>Message:</strong> ${result.message}</p>` : ''}
                    <details>
                        <summary>Dettagli Risposta</summary>
                        <pre style="font-size: 0.8em;">${JSON.stringify(result, null, 2)}</pre>
                    </details>
                </div>
            `;
        }
        
        function showDoubleResult(elementId, result1, result2, test1Name, test2Name) {
            const html = `
                <div class="row">
                    <div class="col-md-6">
                        ${getResultHtml(result1, test1Name)}
                    </div>
                    <div class="col-md-6">
                        ${getResultHtml(result2, test2Name)}
                    </div>
                </div>
            `;
            document.getElementById(elementId).innerHTML = html;
        }
        
        function getResultHtml(result, testName) {
            const isSuccess = result.success;
            const badgeClass = isSuccess ? 'bg-success' : 'bg-danger';
            const icon = isSuccess ? 'check-circle' : 'exclamation-triangle';
            
            return `
                <div class="alert alert-${isSuccess ? 'success' : 'danger'}">
                    <h6><span class="badge ${badgeClass}">
                        <i class="fas fa-${icon} me-1"></i>
                        ${testName}
                    </span></h6>
                    <p><strong>Status:</strong> ${isSuccess ? 'SUCCESS' : 'ERROR'}</p>
                    ${result.message ? `<p><strong>Message:</strong> ${result.message}</p>` : ''}
                </div>
            `;
        }
        
        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="alert alert-danger">
                    <h6><span class="badge bg-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        ERROR
                    </span></h6>
                    <p>${message}</p>
                </div>
            `;
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-key.js" crossorigin="anonymous"></script>
</body>
</html>